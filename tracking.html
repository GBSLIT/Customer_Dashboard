<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PO Tracking</title>
  <style>
    /* Base */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: url('images/background.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    .container {
      width: 100%;
      max-width: 1350px;
      margin: 0 auto;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow-x: hidden;
    }

    /* Header: logo left, title centered */
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background-color: #fbfbfb;
      color: black;
      padding: 35px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .header img { height: 50px; position: absolute; left: 35px; }
    .header h1 { font-size: 24px; margin: 0; text-align: center; width: 100%; }

    /* Tracking summary */
    .tracking-info {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px 20px;
    }
    .tracking-info div { flex: 1 1 45%; min-width: 240px; margin: 10px 0; }
    .tracking-info b { font-size: 16px; margin-left: 20px; }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 720px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    th { background-color: #f4f4f4; }

    /* Timeline container */
    .visualization {
      position: relative;
      margin: 40px 0;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      align-items: start;
      gap: 0;
    }

    /* Real lines (drawn by JS with exact pixel positions) */
    .timeline-base,
    .timeline-progress {
      position: absolute;
      height: 2px;
      left: 0;
      top: 0;
    }
    .timeline-base { background: #ccc; z-index: 0; }
    .timeline-progress { background: #1fd655; z-index: 1; }

    .step { position: relative; text-align: center; padding-top: 10px; }
    .step .step-dot {
      width: 25px; height: 25px; border-radius: 50%; background-color: #ccc;
      margin: 24px auto 8px; position: relative; z-index: 2; /* above lines */
    }
    .step.done .step-dot { background-color: #1fd655 !important; }
    .step .check {
      position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
      font-size: 18px; z-index: 3;
    }

    /* Mobile header stack so logo never overlaps title */
    @media (max-width: 600px) {
      .header { padding: 16px; justify-content: center; align-items: center; flex-direction: column; }
      .header img { position: static; left: auto; margin: 0 auto 8px; height: 42px; display: block; }
      .header h1 { width: auto; text-align: center; font-size: 20px; margin: 0; }
    }

    /* Mobile timeline: horizontal scroll for steps, lines still computed in JS */
    @media (max-width: 600px) {
      .visualization { display: flex; overflow-x: auto; gap: 32px; padding-bottom: 6px; scroll-snap-type: x mandatory; }
      .visualization::-webkit-scrollbar { height: 0; }
      .visualization { scrollbar-width: none; }
      .step { flex: 0 0 220px; scroll-snap-align: start; }
    }

    @media (max-width: 480px) {
      .tracking-info div { flex: 1 1 100%; min-width: 0; }
      table { min-width: 560px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="images/logo.png" alt="GBSL">
      <h1>PO Tracking</h1>
    </div>

    <div class="tracking-info">
      <div><b>PO Number</b> – <span id="trackingPONumber"></span></div>
      <div><b>Customer Name</b> – <span id="trackingCustomerName"></span></div>
      <div><b>ETD</b> – <span id="trackingETD"></span></div>
      <div><b>Vendor Name</b> – <span id="trackingPortOfOrigin"></span></div>
      <div><b>Country</b> – <span id="trackingPortOfDestination"></span></div>
      <div><b>Current Stage</b> – <span id="trackingCurrentStage"></span></div>
    </div>

    <div class="visualization" id="visualization">
      <!-- JS will insert: .timeline-base, .timeline-progress and the 7 steps -->
    </div>

    <div style="overflow-x:auto;">
      <table id="trackingTable">
        <tr>
          <th>Step</th><th>Planned Date</th><th>Actual Date</th><th>Status</th><th>Documents Link</th>
        </tr>
        <tr><td>Pre-Production Meeting</td><td id="ppPlannedDate"></td><td id="ppActualDate"></td><td id="ppStatus"></td><td id="ppRemark"></td></tr>
        <tr><td>Label Artwork Approval</td><td id="laPlannedDate"></td><td id="laActualDate"></td><td id="laStatus"></td><td id="laRemark"></td></tr>
        <tr><td>Cargo Booking submission and SO Received</td><td id="cbPlannedDate"></td><td id="cbActualDate"></td><td id="cbStatus"></td><td id="cbRemark"></td></tr>
        <tr><td>Midline Inspection</td><td id="miPlannedDate"></td><td id="miActualDate"></td><td id="miStatus"></td><td id="miRemark"></td></tr>
        <tr><td>Final Inspection Report Submission and Approval</td><td id="fiPlannedDate"></td><td id="fiActualDate"></td><td id="fiStatus"></td><td id="fiRemark"></td></tr>
        <tr><td>Loading and Submission of Report</td><td id="blPlannedDate"></td><td id="blActualDate"></td><td id="blStatus"></td><td id="blRemark"></td></tr>
        <tr><td>Payment Realization and Confirmation</td><td id="prPlannedDate"></td><td id="prActualDate"></td><td id="prStatus"></td><td id="prRemark"></td></tr>
      </table>
    </div>
  </div>

  <script>
    const API_KEY = 'AIzaSyDIQwldr8SG1D71XI82vGycV0ueZ-cesV0';
    const SPREADSHEET_ID = '1NwNkVa2wg2hSFreDPX9CHM2m-9gk4wZz8gj4xFDnA3E';
    const ORDER_RANGE = 'Orders!A1:G';
    const TRACKING_RANGE = 'Tracking!A1:AC';

    async function fetchData(range) {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`);
      const data = await res.json();
      if (data.error) { console.error('Error fetching data:', data.error); return []; }
      return data.values;
    }

    function getQueryParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function populateTrackingDetails(poNumber) {
      const ordersData = await fetchData(ORDER_RANGE);
      const trackingData = await fetchData(TRACKING_RANGE);
      const poOrderData = ordersData.find(order => order[1] === poNumber);
      const poTrackingData = trackingData.find(row => row[0] === poNumber);

      if (poOrderData) {
        document.getElementById('trackingPONumber').textContent = poOrderData[1] || ' ';
        document.getElementById('trackingCustomerName').textContent = poOrderData[2] || ' ';
        document.getElementById('trackingETD').textContent = poOrderData[5] || 'N/A';
        document.getElementById('trackingPortOfOrigin').textContent = poOrderData[3] || ' ';
        document.getElementById('trackingPortOfDestination').textContent = poOrderData[4] || ' ';
        document.getElementById('trackingCurrentStage').textContent = poOrderData[6] || ' ';
      }

      if (poTrackingData) {
        const map = [
          { id: 'ppPlannedDate', i: 1 }, { id: 'ppActualDate', i: 2 }, { id: 'ppStatus', i: 3 }, { id: 'ppRemark', i: 4 },
          { id: 'laPlannedDate', i: 5 }, { id: 'laActualDate', i: 6 }, { id: 'laStatus', i: 7 }, { id: 'laRemark', i: 8 },
          { id: 'cbPlannedDate', i: 9 }, { id: 'cbActualDate', i: 10 }, { id: 'cbStatus', i: 11 }, { id: 'cbRemark', i: 12 },
          { id: 'miPlannedDate', i: 13 }, { id: 'miActualDate', i: 14 }, { id: 'miStatus', i: 15 }, { id: 'miRemark', i: 16 },
          { id: 'fiPlannedDate', i: 17 }, { id: 'fiActualDate', i: 18 }, { id: 'fiStatus', i: 19 }, { id: 'fiRemark', i: 20 },
          { id: 'blPlannedDate', i: 21 }, { id: 'blActualDate', i: 22 }, { id: 'blStatus', i: 23 }, { id: 'blRemark', i: 24 },
          { id: 'prPlannedDate', i: 25 }, { id: 'prActualDate', i: 26 }, { id: 'prStatus', i: 27 }, { id: 'prRemark', i: 28 }
        ];
        map.forEach(m => { const el = document.getElementById(m.id); if (el) el.textContent = poTrackingData[m.i] || ''; });

        const dataSlice = poTrackingData.slice(1);
        const redraw = () => updateVisualization(dataSlice);
        redraw();
        window.addEventListener('resize', redraw);
        // also redraw after fonts load which can slightly move dots on mobile
        if ('fonts' in document) document.fonts.ready.then(redraw);
      }
    }

    function updateVisualization(trackingData) {
      const steps = [
        'Pre-Production Meeting',
        'Label Artwork Approval',
        'Midline Inspection',
        'Cargo Booking submission and SO Received',
        'Final Inspection Report Submission and Approval',
        'Loading and Submission of Report',
        'Payment Realization and Confirmation'
      ];

      const viz = document.getElementById('visualization');
      viz.innerHTML = '';

      // Lines created first so they sit behind dots
      const baseLine = document.createElement('div');
      baseLine.className = 'timeline-base';
      const progLine = document.createElement('div');
      progLine.className = 'timeline-progress';
      viz.appendChild(baseLine);
      viz.appendChild(progLine);

      // Build steps
      let completed = 0;
      steps.forEach((label, idx) => {
        const done = trackingData[idx * 4 + 2] === 'Done';
        if (done) completed += 1;

        const stepDiv = document.createElement('div');
        stepDiv.className = 'step' + (done ? ' done' : '');

        const dot = document.createElement('div');
        dot.className = 'step-dot';
        stepDiv.appendChild(dot);

        if (done) {
          const check = document.createElement('div');
          check.className = 'check';
          check.textContent = '✔️';
          stepDiv.appendChild(check);
        }

        const text = document.createElement('div');
        text.textContent = label;
        stepDiv.appendChild(text);

        viz.appendChild(stepDiv);
      });

      // After DOM paints, measure positions and set lines
      requestAnimationFrame(() => {
        const dots = viz.querySelectorAll('.step .step-dot');
        if (dots.length < 2) return;

        const box = viz.getBoundingClientRect();
        const first = dots[0].getBoundingClientRect();
        const last = dots[dots.length - 1].getBoundingClientRect();

        const y = (first.top - box.top) + first.height / 2;
        const start = (first.left - box.left) + first.width / 2;
        const endBase = (last.left - box.left) + last.width / 2;

        // Find last completed dot (if none, progress is 0)
        const doneDots = viz.querySelectorAll('.step.done .step-dot');
        let endProg = start;
        if (doneDots.length) {
          const lastDone = doneDots[doneDots.length - 1].getBoundingClientRect();
          endProg = (lastDone.left - box.left); // stop at left edge of last completed dot
        }

        // Apply exact pixel sizes
        baseLine.style.top = y + 'px';
        baseLine.style.left = start + 'px';
        baseLine.style.width = Math.max(0, endBase - start) + 'px';

        progLine.style.top = y + 'px';
        progLine.style.left = start + 'px';
        progLine.style.width = Math.max(0, endProg - start) + 'px';
      });
    }

    const poNumber = getQueryParameter('po');
    if (poNumber) populateTrackingDetails(poNumber);
    else console.error('PO number not found in URL query parameter');
  </script>
</body>
</html>
